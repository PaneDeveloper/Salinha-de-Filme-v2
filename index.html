<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Salinha de Filme com Chat :3</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Simple-Peer WebRTC -->
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>

<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #111827;
    color: #e5e7eb;
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
  }
  #chatMessages {
    max-height: 300px;
    overflow-y: auto;
    padding: 0.5rem;
    background: #1f2937;
    border-radius: 0.5rem;
  }
  #chatMessages div {
    margin-bottom: 0.5rem;
  }
  .system-msg {
    text-align: center;
    font-style: italic;
    color: #9ca3af;
  }
  /* Estilos para o modal de solicitação de entrada */
  #joinRequestModal {
    z-index: 1000; /* Garante que o modal esteja acima de outros elementos */
  }
  #waitingForApprovalModal {
    z-index: 1000;
  }
</style>
</head>
<body>

<div id="container" style="max-width: 480px; width: 100%;">

  <div id="menu">
    <h1 class="text-3xl font-bold mb-2">Salinha de filme</h1>
    <p class="mb-6">Crie uma sala para assistir com seus amigos :3</p>

    <button id="btnCreateRoom" class="w-full py-3 mb-4 bg-indigo-600 rounded text-white font-bold">Criar Nova Sala</button>

    <div class="flex gap-2 mb-4">
      <input id="roomInput" placeholder="CÓDIGO DA SALA" maxlength="4" class="flex-grow p-3 rounded bg-gray-700 text-white uppercase" />
      <button id="btnJoinRoom" class="py-3 px-5 bg-gray-600 rounded text-white font-bold">Entrar</button>
    </div>

    <p id="authStatus" class="text-gray-400 text-sm">Autenticando...</p>
  </div>

  <div id="app" class="hidden flex flex-col">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Sala: <span id="roomCodeDisplay" class="text-indigo-400"></span></h2>
      <button id="btnLeaveRoom" class="bg-red-600 text-white px-3 py-1 rounded">Sair da Sala</button>
    </div>

    <!-- Adicionado o atributo 'muted' para garantir a reprodução automática em todos os navegadores -->
    <video id="remoteVideo" autoplay playsinline muted class="w-full h-64 bg-black rounded mb-4"></video>

    <div id="videoPlaceholder" class="text-center text-gray-400 mb-4">
      <p>Esperando o host compartilhar a tela...</p>
      <button id="btnStartShare" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded font-bold">Compartilhar Tela</button>
    </div>

    <div id="chatMessages" class="mb-3"></div>

    <div class="flex gap-2">
      <input id="chatInput" placeholder="Digite sua mensagem..." class="flex-grow p-2 rounded bg-gray-700 text-white" />
      <button id="sendChatBtn" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Enviar</button>
    </div>
  </div>

</div>

<!-- Modal de Solicitação de Entrada (para o Admin) -->
<div id="joinRequestModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
  <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
    <p class="text-lg mb-4">Usuário <span id="requesterIdDisplay" class="font-bold text-indigo-400 break-all"></span> deseja entrar na sala.</p>
    <div class="flex justify-center gap-4">
      <button id="acceptJoinBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold transition duration-300">Aceitar</button>
      <button id="rejectJoinBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold transition duration-300">Recusar</button>
    </div>
  </div>
</div>

<!-- Modal de Espera por Aprovação (para o Usuário Tentando Entrar) -->
<div id="waitingForApprovalModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden">
  <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
    <p class="text-lg mb-4">Aguardando aprovação do host para entrar na sala...</p>
    <p class="text-sm text-gray-400">Código da sala: <span id="waitingRoomCodeDisplay" class="font-bold text-indigo-400"></span></p>
    <button id="cancelWaitingBtn" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold transition duration-300">Cancelar</button>
  </div>
</div>


<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

<script>
  // === CONFIGURAÇÃO FIREBASE ===
  // Esta configuração foi fornecida pelo seu console do Firebase para o projeto "Salinha de Filme".
  // É crucial que esses valores estejam corretos para que o aplicativo se conecte aos serviços do Firebase.
  const firebaseConfig = {
    apiKey: "AIzaSyA3HIqR4rT3NANEulauFy_-3OkuWOqYhqk",
    authDomain: "salinha-de-filme.firebaseapp.com",
    projectId: "salinha-de-filme",
    storageBucket: "salinha-de-filme.firebasestorage.app",
    messagingSenderId: "589071044223",
    appId: "1:589071044223:web:2e8c6e0b4644bc99fbf94a"
  };

  // Inicializa o Firebase com a configuração fornecida
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // DOM elements
  const btnCreateRoom = document.getElementById('btnCreateRoom');
  const btnJoinRoom = document.getElementById('btnJoinRoom');
  const roomInput = document.getElementById('roomInput');
  const authStatus = document.getElementById('authStatus');

  const menu = document.getElementById('menu');
  const app = document.getElementById('app');
  const roomCodeDisplay = document.getElementById('roomCodeDisplay');
  const btnLeaveRoom = document.getElementById('btnLeaveRoom');
  const remoteVideo = document.getElementById('remoteVideo');
  const videoPlaceholder = document.getElementById('videoPlaceholder');
  const btnStartShare = document = document.getElementById('btnStartShare');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');

  // Elementos do Modal de Solicitação de Entrada (para o Admin)
  const joinRequestModal = document.getElementById('joinRequestModal');
  const requesterIdDisplay = document.getElementById('requesterIdDisplay');
  const acceptJoinBtn = document.getElementById('acceptJoinBtn');
  const rejectJoinBtn = document.getElementById('rejectJoinBtn');

  // Elementos do Modal de Espera por Aprovação (para o Usuário Tentando Entrar)
  const waitingForApprovalModal = document.getElementById('waitingForApprovalModal');
  const waitingRoomCodeDisplay = document.getElementById('waitingRoomCodeDisplay');
  const cancelWaitingBtn = document.getElementById('cancelWaitingBtn');


  let userId = null;
  let currentRoomId = null;
  let peer = null;
  let localStream = null;
  let isRoomCreator = false; // Flag para identificar se o usuário é o criador da sala

  let unsubscribeRoom = null;
  let unsubscribeChat = null;
  let unsubscribeCandidates = null;
  let unsubscribeJoinRequests = null; // Novo listener para solicitações de entrada
  let unsubscribeMyJoinRequest = null; // Novo listener para a própria solicitação de entrada


  /**
   * Exibe uma mensagem no painel de chat.
   * @param {string} text - O texto da mensagem.
   * @param {string|null} sender - O remetente da mensagem (ex: 'Você', 'Amigo'). Nulo para mensagens do sistema.
   * @param {boolean} isSystem - Verdadeiro se for uma mensagem do sistema.
   */
  function showMessage(text, sender = null, isSystem = false) {
    const div = document.createElement('div');
    if (isSystem) {
      div.textContent = text;
      div.classList.add('system-msg');
    } else {
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
    }
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight; // Rola para a mensagem mais recente
  }

  // Listener de estado de autenticação do Firebase.
  // Garante que o usuário esteja autenticado (anonimamente) e atualiza a UI.
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      authStatus.textContent = 'Conectado com sucesso!';
      btnCreateRoom.disabled = false;
      btnJoinRoom.disabled = false;
      console.log("Usuário autenticado com ID:", userId); // Log para depuração
    } else {
      userId = null;
      authStatus.textContent = 'Autenticando...';
      btnCreateRoom.disabled = true;
      btnJoinRoom.disabled = true;
      // Tenta autenticar anonimamente se não houver usuário logado
      if (!auth.currentUser) {
        auth.signInAnonymously().catch(err => {
          authStatus.textContent = 'Não foi possível conectar aos serviços: ' + err.message;
          console.error("Erro na autenticação anônima:", err);
          // IMPORTANTE: Se você receber o erro "CONFIGURATION_NOT_FOUND",
          // isso geralmente significa que o método de login "Anônimo"
          // NÃO ESTÁ HABILITADO no seu projeto Firebase.
          // Para corrigir:
          // 1. Vá para o Console do Firebase (console.firebase.google.com).
          // 2. Selecione seu projeto "Salinha de Filme".
          // 3. No menu lateral, clique em "Authentication" (Autenticação).
          // 4. Vá para a aba "Sign-in method" (Método de login).
          // 5. Encontre "Anonymous" (Anônimo) e HABILITE-O.
        });
      }
    }
  });

  /**
   * Gera um código de sala aleatório de 4 letras maiúsculas.
   * @returns {string} O código da sala.
   */
  function generateRoomCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let code = '';
    for(let i=0; i<4; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  // Evento de clique para o botão "Create New Room"
  btnCreateRoom.onclick = async () => {
    if (!userId) {
      alert('Autenticando... Por favor aguarde.');
      return;
    }

    btnCreateRoom.disabled = true;
    btnCreateRoom.textContent = 'Criando...';

    currentRoomId = generateRoomCode();
    roomCodeDisplay.textContent = currentRoomId;
    isRoomCreator = true; // Define o usuário como criador da sala

    const roomRef = db.collection('movie-rooms').doc(currentRoomId);
    const callerCandidates = roomRef.collection('callerCandidates');

    // Inicializa o SimplePeer como iniciador.
    // O stream local é adicionado apenas quando o usuário clica em "Compartilhar Tela".
    peer = new SimplePeer({ initiator: true, trickle: true });

    // Listener para sinais do SimplePeer.
    // Envia a oferta inicial e os ICE candidates para o Firestore.
    peer.on('signal', async data => {
      if (data.type === 'offer') {
        await roomRef.set({
          offer: data,
          creatorId: userId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else if (data.candidate) {
        await callerCandidates.add(data);
      }
    });

    // Listener para o documento da sala no Firestore.
    // Espera pela resposta (answer) do outro peer.
    unsubscribeRoom = roomRef.onSnapshot(snapshot => {
      const data = snapshot.data();
      if (data && data.answer) {
        // Sinaliza o peer com a resposta do outro lado, se for o iniciador.
        if (peer && peer.initiator && data.answer.type === 'answer') {
          peer.signal(data.answer);
        }
      }
    }, error => {
      console.error("Erro ao ouvir o documento da sala:", error);
      showMessage("Erro ao carregar dados da sala.", null, true);
    });

    // Listener para os ICE candidates do outro peer (callee).
    const calleeCandidates = roomRef.collection('calleeCandidates');
    unsubscribeCandidates = calleeCandidates.onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          // Adiciona os ICE candidates recebidos ao peer.
          peer.signal(change.doc.data());
        }
      });
    }, error => {
      console.error("Erro ao ouvir os candidatos do callee:", error);
      showMessage("Erro na comunicação de rede.", null, true);
    });

    // NOVO: Listener para solicitações de entrada (apenas para o criador da sala)
    const joinRequestsRef = roomRef.collection('joinRequests');
    unsubscribeJoinRequests = joinRequestsRef.onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added' && change.doc.data().status === 'pending') {
          const requesterId = change.doc.data().requesterId;
          const requestId = change.doc.id;
          showJoinRequestModal(requesterId, requestId);
        }
      });
    }, error => {
      console.error("Erro ao ouvir solicitações de entrada:", error);
    });

    // Evento de conexão bem-sucedida do WebRTC.
    peer.on('connect', () => {
      showMessage('Amigo conectado!', null, true);
    });

    // Evento de recebimento de stream de vídeo/áudio do outro peer.
    peer.on('stream', stream => {
      videoPlaceholder.style.display = 'none'; // Esconde o placeholder
      remoteVideo.srcObject = stream; // Define o stream como fonte do vídeo remoto
    });

    // Evento de fechamento da conexão WebRTC.
    peer.on('close', () => {
      showMessage('Amigo desconectado.', null, true);
      hangUp(); // Reseta a UI e o estado
    });

    // Evento de erro na conexão WebRTC.
    peer.on('error', err => {
      alert('Erro na conexão: ' + err.message);
      console.error("Erro SimplePeer:", err);
      hangUp(); // Reseta a UI e o estado
    });

    // Esconde o menu e mostra a interface do aplicativo.
    menu.style.display = 'none';
    app.style.display = 'flex';
    setupChatListener(); // Inicia o listener de chat para a nova sala

    btnCreateRoom.textContent = 'Create New Room'; // Restaura o texto do botão
  };

  // Evento de clique para o botão "Entrar" na sala
  btnJoinRoom.onclick = async () => {
    if (!userId) {
      alert('Autenticando... Por favor aguarde.');
      return;
    }

    const code = roomInput.value.trim().toUpperCase();
    if (!code || code.length !== 4) {
      alert('Por favor, insira um código válido de 4 letras.');
      return;
    }

    btnJoinRoom.disabled = true;
    btnJoinRoom.textContent = 'Entrando...';

    currentRoomId = code;
    roomCodeDisplay.textContent = currentRoomId;
    isRoomCreator = false; // Define o usuário como não criador da sala

    const roomRef = db.collection('movie-rooms').doc(currentRoomId);
    const roomSnapshot = await roomRef.get();

    if (!roomSnapshot.exists) {
      alert(`A sala "${currentRoomId}" não foi encontrada.`);
      btnJoinRoom.disabled = false;
      btnJoinRoom.textContent = 'Entrar';
      return;
    }

    const roomData = roomSnapshot.data();

    // NOVO: Envia solicitação de entrada e espera por aprovação
    const joinRequestsRef = roomRef.collection('joinRequests');
    const myJoinRequestRef = await joinRequestsRef.add({
      requesterId: userId,
      status: 'pending',
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    waitingRoomCodeDisplay.textContent = currentRoomId;
    waitingForApprovalModal.classList.remove('hidden'); // Mostra o modal de espera

    // Listener para a própria solicitação de entrada
    unsubscribeMyJoinRequest = myJoinRequestRef.onSnapshot(async snapshot => {
      const data = snapshot.data();
      if (data && data.status === 'accepted') {
        waitingForApprovalModal.classList.add('hidden'); // Esconde o modal de espera
        showMessage('Sua solicitação foi aceita! Conectando...', null, true);

        // Prossegue com a conexão WebRTC após a aceitação
        peer = new SimplePeer({ initiator: false, trickle: true });
        peer.signal(roomData.offer);

        peer.on('signal', async data => {
          if (data.type === 'answer') {
            await roomRef.update({ answer: data });
          } else if (data.candidate) {
            const calleeCandidates = roomRef.collection('calleeCandidates');
            await calleeCandidates.add(data);
          }
        });

        const callerCandidates = roomRef.collection('callerCandidates');
        unsubscribeCandidates = callerCandidates.onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              peer.signal(change.doc.data());
            }
          });
        }, error => {
          console.error("Erro ao ouvir os candidatos do caller:", error);
          showMessage("Erro na comunicação de rede.", null, true);
        });

        peer.on('connect', () => {
          showMessage('Amigo conectado!', null, true);
        });

        peer.on('stream', stream => {
          videoPlaceholder.style.display = 'none';
          remoteVideo.srcObject = stream;
        });

        peer.on('close', () => {
          showMessage('Amigo desconectado.', null, true);
          hangUp();
        });

        peer.on('error', err => {
          alert('Erro na conexão: ' + err.message);
          console.error("Erro SimplePeer:", err);
          hangUp();
        });

        menu.style.display = 'none';
        app.style.display = 'flex';
        setupChatListener();

      } else if (data && data.status === 'rejected') {
        waitingForApprovalModal.classList.add('hidden'); // Esconde o modal de espera
        alert('Sua solicitação para entrar na sala foi recusada.');
        hangUp(); // Volta para o menu
      } else if (!data) { // Se o documento for deletado (ex: admin não aceitou/rejeitou e limpou)
        waitingForApprovalModal.classList.add('hidden');
        alert('Sua solicitação expirou ou foi cancelada.');
        hangUp();
      }
    }, error => {
      console.error("Erro ao ouvir sua solicitação de entrada:", error);
      waitingForApprovalModal.classList.add('hidden');
      alert('Erro ao verificar o status da solicitação. Tente novamente.');
      hangUp();
    });

    btnJoinRoom.disabled = false;
    btnJoinRoom.textContent = 'Entrar';
  };

  // Evento de clique para o botão "Compartilhar Tela"
  btnStartShare.onclick = async () => {
    try {
      // Se já houver um stream local ativo, remove-o e para as faixas antes de iniciar um novo.
      if (localStream) {
        if (peer) peer.removeStream(localStream); // Remove do peer se ele existir
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      // Solicita acesso à tela e áudio do usuário.
      localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });

      // Adiciona o stream local ao peer, se o peer já estiver inicializado.
      if (peer) {
        peer.addStream(localStream);
        // NOVO: Exibe o stream local no player principal para o host
        remoteVideo.srcObject = localStream;
        videoPlaceholder.style.display = 'none'; // Esconde o placeholder
      } else {
        console.warn('Peer não inicializado. Não foi possível adicionar o stream de tela.');
        // Se o peer não estiver pronto, para o stream que acabou de ser obtido.
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
        alert('Por favor, crie ou entre em uma sala antes de compartilhar a tela.');
        return;
      }

      // Listener para quando o compartilhamento de tela é encerrado (ex: usuário clica em "Parar compartilhamento").
      localStream.getVideoTracks()[0].onended = () => {
        showMessage('Compartilhamento de tela encerrado.', null, true);
        btnStartShare.disabled = false;
        btnStartShare.textContent = 'Compartilhar Tela';
        if (localStream) {
          if (peer) peer.removeStream(localStream); // Remove o stream do peer
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
          // Quando o compartilhamento local termina, o player principal deve voltar a mostrar o placeholder
          remoteVideo.srcObject = null; // Limpa o vídeo
          videoPlaceholder.style.display = 'block'; // Mostra o placeholder
        }
      };

      btnStartShare.disabled = true;
      btnStartShare.textContent = 'Compartilhando...';
    } catch (err) {
      alert('Não foi possível compartilhar a tela. Verifique permissões do navegador ou se você já está compartilhando.');
      console.error("Erro ao compartilhar tela:", err);
    }
  };

  // Evento de clique para o botão "Enviar" do chat
  sendChatBtn.onclick = async () => {
    const text = chatInput.value.trim();
    if (!text || !currentRoomId) return; // Não envia mensagem vazia ou se não estiver em uma sala

    showMessage(text, 'Você'); // Exibe a própria mensagem no chat local
    chatInput.value = ''; // Limpa o campo de input

    try {
      const chatRef = db.collection('movie-rooms').doc(currentRoomId).collection('chat');
      await chatRef.add({
        text,
        senderId: userId,
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Adiciona timestamp do servidor
      });
    } catch (e) {
      showMessage('Falha ao enviar a mensagem.', null, true);
      console.error("Erro ao enviar mensagem de chat:", e);
    }
  };

  // Evento de teclado para enviar mensagem do chat com Enter
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { // Envia com Enter, mas permite Shift+Enter para quebra de linha
      e.preventDefault(); // Previne a quebra de linha padrão do Enter
      sendChatBtn.click(); // Simula o clique no botão de enviar
    }
  });

  /**
   * Configura o listener em tempo real para as mensagens do chat no Firestore.
   * As mensagens são exibidas no chatMessages.
   */
  function setupChatListener() {
    // Garante que listeners anteriores sejam desinscritos antes de criar novos
    if (unsubscribeChat) unsubscribeChat();

    const chatRef = db.collection('movie-rooms').doc(currentRoomId).collection('chat').orderBy('timestamp');
    unsubscribeChat = chatRef.onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const data = change.doc.data();
          // Exibe a mensagem apenas se o remetente não for o usuário atual
          if (data.senderId !== userId) {
            showMessage(data.text, 'Amigo');
          }
        }
      });
    }, error => {
      console.error("Erro ao ouvir o chat:", error);
      showMessage("Não foi possível carregar as mensagens do chat.", null, true);
    });
  }

  /**
   * Exibe o modal de solicitação de entrada para o administrador.
   * @param {string} requesterId - O ID do usuário que está solicitando a entrada.
   * @param {string} requestId - O ID do documento da solicitação no Firestore.
   */
  function showJoinRequestModal(requesterId, requestId) {
    requesterIdDisplay.textContent = requesterId;
    joinRequestModal.classList.remove('hidden');

    // Remove listeners anteriores para evitar duplicação
    acceptJoinBtn.onclick = null;
    rejectJoinBtn.onclick = null;

    // Configura os botões do modal
    acceptJoinBtn.onclick = async () => {
      await db.collection('movie-rooms').doc(currentRoomId).collection('joinRequests').doc(requestId).update({ status: 'accepted' });
      joinRequestModal.classList.add('hidden');
      showMessage(`Solicitação de ${requesterId} aceita.`, null, true);
    };

    rejectJoinBtn.onclick = async () => {
      await db.collection('movie-rooms').doc(currentRoomId).collection('joinRequests').doc(requestId).update({ status: 'rejected' });
      joinRequestModal.classList.add('hidden');
      showMessage(`Solicitação de ${requesterId} recusada.`, null, true);
    };
  }

  // Evento de clique para o botão "Sair da Sala"
  btnLeaveRoom.onclick = () => {
    hangUp(); // Chama a função para limpar e resetar tudo
  };

  // Evento de clique para o botão "Cancelar" no modal de espera por aprovação
  cancelWaitingBtn.onclick = async () => {
    if (unsubscribeMyJoinRequest) {
      unsubscribeMyJoinRequest(); // Para de ouvir a própria solicitação
      unsubscribeMyJoinRequest = null;
    }
    // Opcional: Remover a solicitação do Firestore se o usuário cancelar antes da aprovação
    // Isso requer que o ID da solicitação seja armazenado em uma variável global temporária
    // Para simplificar, estamos apenas parando de ouvir e resetando a UI.
    hangUp();
    waitingForApprovalModal.classList.add('hidden');
    alert('Você cancelou a solicitação de entrada.');
  };


  /**
   * Função para encerrar a conexão WebRTC, parar streams e resetar o estado da UI e variáveis.
   */
  function hangUp() {
    // Destroi o objeto SimplePeer
    if (peer) {
      peer.destroy();
      peer = null;
    }
    // Para as faixas do stream de mídia local (se houver)
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    // Desinscreve todos os listeners do Firestore para evitar vazamentos de memória
    if (unsubscribeRoom) {
      unsubscribeRoom();
      unsubscribeRoom = null;
    }
    if (unsubscribeChat) {
      unsubscribeChat();
      unsubscribeChat = null;
    }
    if (unsubscribeCandidates) {
      unsubscribeCandidates();
      unsubscribeCandidates = null;
    }
    if (unsubscribeJoinRequests) { // Desinscreve o listener de solicitações (para o criador)
      unsubscribeJoinRequests();
      unsubscribeJoinRequests = null;
    }
    if (unsubscribeMyJoinRequest) { // Desinscreve o listener da própria solicitação (para quem tenta entrar)
      unsubscribeMyJoinRequest();
      unsubscribeMyJoinRequest = null;
    }


    // Reseta variáveis de estado
    currentRoomId = null;
    remoteVideo.srcObject = null; // Limpa o vídeo remoto
    chatMessages.innerHTML = ''; // Limpa as mensagens do chat
    roomInput.value = ''; // Limpa o input do código da sala
    isRoomCreator = false; // Reseta a flag do criador da sala

    // Alterna a visibilidade da UI (mostra o menu, esconde o app)
    menu.style.display = 'block';
    app.style.display = 'none';

    // Esconde quaisquer modais abertos
    joinRequestModal.classList.add('hidden');
    waitingForApprovalModal.classList.add('hidden');


    // Reseta o estado dos botões e placeholders
    btnCreateRoom.disabled = false;
    btnCreateRoom.textContent = 'Create New Room';
    btnJoinRoom.disabled = false;
    btnJoinRoom.textContent = 'Entrar';
    btnStartShare.disabled = false;
    btnStartShare.textContent = 'Compartilhar Tela';
    videoPlaceholder.style.display = 'block'; // Mostra o placeholder de vídeo novamente
  }

  // Inicialização da aplicação quando a janela é carregada.
  // A autenticação inicial é tratada pelo auth.onAuthStateChanged.
  window.onload = () => {
    btnCreateRoom.disabled = true; // Desabilita botões até a autenticação
    btnJoinRoom.disabled = true;
    // O auth.onAuthStateChanged já lida com o signInAnonymously.
    // Não é necessário chamar signInAnonymously diretamente aqui.
  };
</script>

</body>
</html>
