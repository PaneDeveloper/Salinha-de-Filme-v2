<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Cinema Virtual</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Simple Peer -->
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: #111827;
            background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            color: #e5e7eb;
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            background-color: #1f2937;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        #chatMessages {
            max-height: 250px;
            overflow-y: auto;
            padding: 0.75rem;
            background: #111827;
            border-radius: 0.75rem;
            flex-grow: 1;
            border: 1px solid #374151;
        }
        .system-msg { text-align: center; font-style: italic; color: #9ca3af; margin: 8px 0; }
        .ai-msg { background-color: #374151; padding: 0.75rem; border-radius: 0.75rem; margin-top: 0.5rem; font-size: 0.9rem; line-height: 1.4; }
        .ai-msg p, .ai-msg ol, .ai-msg ul { margin-bottom: 0.5rem; }
        .ai-msg li { margin-left: 1.5rem; }
        .btn-primary { background: linear-gradient(90deg, #6366f1 0%, #4f46e5 100%); transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary:hover { background: linear-gradient(90deg, #4f46e5 0%, #4338ca 100%); transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2); }
        .movie-screen-container { position: relative; background: #000000; border-radius: 1.5rem; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); padding-top: 56.25%; /* 16:9 Aspect Ratio */ border: 4px solid #374151; }
        .movie-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 1.25rem; }
        .pip-button { position: absolute; top: 1rem; right: 1rem; z-index: 10; background-color: rgba(31, 41, 55, 0.7); transition: background-color 0.3s; color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; }
        .pip-button:hover { background-color: rgba(79, 70, 229, 0.9); }
        .chat-toggle-button { background: #374151; color: #d1d5db; padding: 0.75rem 1rem; border-radius: 0.75rem; transition: all 0.3s ease; }
        .chat-toggle-button:hover { background: #4b5563; }
        .chat-status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #1f2937; margin: 15% auto; padding: 20px; border: 1px solid #4b5563; width: 90%; max-width: 400px; border-radius: 0.75rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .modal-large-content { background-color: #1f2937; margin: 5% auto; padding: 24px; border: 1px solid #4b5563; width: 90%; max-width: 600px; border-radius: 0.75rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; transition: color 0.3s; }
        .close-modal:hover, .close-modal:focus { color: #fff; text-decoration: none; cursor: pointer; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading-dot { width: 8px; height: 8px; background-color: #9ca3af; border-radius: 50%; margin: 0 2px; animation: pulse 1.4s infinite ease-in-out both; }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @media (min-width: 768px) {
            #main-content { flex-direction: row; }
            #chat-sidebar { flex: 1; }
            #player-container { flex: 2; }
            #chatMessages { max-height: none; }
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- UI do Menu -->
        <div id="menu" class="w-full flex flex-col items-center p-4">
            <h1 class="text-3xl font-bold mb-2 text-indigo-400">Sala de Cinema Virtual</h1>
            <p class="mb-6 text-gray-400">Crie uma sala para assistir com amigos</p>
            <input id="usernameInput" placeholder="Seu nome de usuário aqui :3" class="w-full p-4 mb-4 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600" />
            <button id="btnCreateRoom" class="w-full py-4 mb-4 btn-primary text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed">Criar Nova Sala</button>
            <div class="flex gap-2 mb-4 w-full">
                <input id="roomInput" placeholder="CÓDIGO DA SALA" maxlength="4" class="flex-grow p-4 rounded-lg bg-gray-700 text-white uppercase focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600" />
                <button id="btnJoinRoom" class="py-4 px-6 bg-gray-600 rounded-lg text-white font-bold hover:bg-gray-500 transition">Entrar</button>
            </div>
            <p id="authStatus" class="text-gray-400 text-sm">Autenticando...</p>
        </div>
        <!-- UI da Aplicação -->
        <div id="app" class="hidden flex-col w-full gap-6">
            <div id="main-content" class="flex flex-col md:flex-row gap-6">
                <!-- Player e código da sala (lado esquerdo) -->
                <div id="player-container" class="flex-1 flex flex-col items-start gap-4">
                    <div class="flex items-center gap-4 px-4 py-2 bg-gray-700 rounded-xl w-full md:w-auto">
                        <h2 class="text-lg font-bold">Código da sala: <span id="roomCodeDisplay" class="text-indigo-400"></span></h2>
                    </div>
                    <div class="w-full text-center text-gray-300 italic mb-4">
                        <p id="videoScreenTitle" class="text-xl">Tela de Projeção</p>
                    </div>
                    <div class="movie-screen-container w-full">
                        <button id="pipButton" class="pip-button" style="display: none;" title="Picture-in-Picture">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <video id="remoteVideo" autoplay playsinline class="movie-screen hidden"></video>
                        <div id="videoPlaceholder" class="movie-screen flex flex-col items-center justify-center text-center text-gray-400 p-8">
                            <div class="p-8 bg-gray-800 rounded-xl">
                                <p id="videoPlaceholderText" class="text-lg mb-4">Esperando o host compartilhar a tela...</p>
                                <div id="hostControls" class="flex flex-col items-center">
                                    <button id="btnStartShare" class="mt-3 btn-primary px-8 text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed">Compartilhar Tela</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Chat e Controles (lado direito) -->
                <div id="chat-sidebar" class="flex-1 flex flex-col gap-4">
                    <!-- Botões alinhados à direita -->
                    <div class="flex flex-col md:flex-row justify-end items-center px-4 gap-4">
                        <button id="btnShowParticipants" class="chat-toggle-button" title="Ver Participantes">
                            <i class="fas fa-users"></i>
                        </button>
                        <button id="toggleChatMode" class="chat-toggle-button" title="Alternar modo de chat">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button id="btnLeaveRoom" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Sair</button>
                    </div>
                    <div id="textChatView" class="flex flex-col gap-4 h-full">
                        <h3 class="text-xl font-semibold text-center">Chat da Sala</h3>
                        <div id="ai-features" class="flex flex-col gap-2">
                            <button id="btnGenerateInvitation" class="btn-primary w-full text-left text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed">Gerar Convite ✨</button>
                            <button id="btnGenerateIcebreakers" class="btn-primary w-full text-left text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed">Sugestões de Conversa ✨</button>
                        </div>
                        <div id="chatMessages"></div>
                        <div class="flex gap-2 mt-auto">
                            <input id="chatInput" placeholder="Digite sua mensagem..." class="flex-grow p-3 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600" />
                            <button id="sendChatBtn" class="btn-primary px-4 py-2 text-white font-bold">Enviar</button>
                        </div>
                    </div>
                    <div id="voiceChatView" class="hidden flex-col items-center justify-center p-4 h-full">
                        <h3 class="text-xl font-semibold mb-3 text-center">Voice Chat</h3>
                        <div class="flex items-center gap-2 mb-4">
                            <span id="voiceStatusIndicator" class="chat-status-indicator bg-gray-500"></span>
                            <span id="voiceStatusText" class="text-lg">Pronto para entrar</span>
                        </div>
                        <div id="voiceChatControls" class="flex flex-col gap-4 w-full text-center">
                            <p id="voiceChatInfo" class="text-sm text-gray-400">Entre para conversar por voz com os outros participantes.</p>
                            <button id="btnJoinVoiceChat" class="w-full py-3 btn-primary text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                                Entrar no Voice Chat
                            </button>
                            <div id="voiceChatActiveInfo" class="hidden flex flex-col items-center gap-2">
                                <p id="remoteVoiceStatus" class="text-sm text-gray-400">Aguardando outro(s) participante(s)...</p>
                                <button id="btnToggleMute" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-microphone"></i> Silenciar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Participantes -->
    <div id="participantsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3 class="text-xl font-bold mb-4">Participantes da Sala</h3>
            <ul id="participantsList" class="list-none p-0 space-y-2">
            </ul>
        </div>
    </div>
    <!-- Modal para o Convite -->
    <div id="invitationModal" class="modal">
        <div class="modal-large-content">
            <span class="close-modal">&times;</span>
            <h3 class="text-xl font-bold mb-4">Seu Convite ✨</h3>
            <pre id="invitationText" class="bg-gray-800 p-4 rounded-lg text-sm whitespace-pre-wrap border border-gray-700"></pre>
            <div class="flex justify-end mt-4">
                <button id="copyInvitationBtn" class="btn-primary text-white font-bold">Copiar</button>
            </div>
        </div>
    </div>

    <script>
        // === FIREBASE CONFIGURATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyA3HIqR4rT3NANEulauFy_-3OkuWOqYhqk",
            authDomain: "salinha-de-filme.firebaseapp.com",
            projectId: "salinha-de-filme",
            storageBucket: "salinha-de-filme.appspot.com",
            messagingSenderId: "589071044223",
            appId: "1:589071044223:web:2e8c6e0b4644bc99fbf94a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === DOM ELEMENTS & STATE VARIABLES ===
        const btnCreateRoom = document.getElementById('btnCreateRoom');
        const btnJoinRoom = document.getElementById('btnJoinRoom');
        const roomInput = document.getElementById('roomInput');
        const usernameInput = document.getElementById('usernameInput');
        const authStatus = document.getElementById('authStatus');
        const menu = document.getElementById('menu');
        const app = document.getElementById('app');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const btnLeaveRoom = document.getElementById('btnLeaveRoom');
        const remoteVideo = document.getElementById('remoteVideo');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const btnStartShare = document.getElementById('btnStartShare');
        const pipButton = document.getElementById('pipButton');
        const videoPlaceholderText = document.getElementById('videoPlaceholderText');
        const hostControls = document.getElementById('hostControls');

        const toggleChatMode = document.getElementById('toggleChatMode');
        const textChatView = document.getElementById('textChatView');
        const voiceChatView = document.getElementById('voiceChatView');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const btnJoinVoiceChat = document.getElementById('btnJoinVoiceChat');
        const voiceStatusText = document.getElementById('voiceStatusText');
        const voiceStatusIndicator = document.getElementById('voiceStatusIndicator');
        const voiceChatActiveInfo = document.getElementById('voiceChatActiveInfo');
        const voiceChatInfo = document.getElementById('voiceChatInfo');
        const btnToggleMute = document.getElementById('btnToggleMute');

        const btnShowParticipants = document.getElementById('btnShowParticipants');
        const participantsModal = document.getElementById('participantsModal');
        const invitationModal = document.getElementById('invitationModal');
        const invitationText = document.getElementById('invitationText');
        const copyInvitationBtn = document.getElementById('copyInvitationBtn');
        const closeModal = document.querySelectorAll('.close-modal');
        const participantsList = document.getElementById('participantsList');

        const btnGenerateInvitation = document.getElementById('btnGenerateInvitation');
        const btnGenerateIcebreakers = document.getElementById('btnGenerateIcebreakers');

        let userId = null;
        let currentRoomId = null;
        let username = null;
        let isRoomCreator = false;
        let localStream = null;
        
        // Estado inicial: o narrador está desativado por padrão
        let ttsEnabled = false;
        let isTtsAllEnabled = false;

        // State for video and voice connections
        let peers = new Map(); // Store all peer connections (video and voice)
        let unsubscribers = []; // Store all Firestore unsubscribers

        // === INITIALIZATION AND HELPER FUNCTIONS ===
        function showCustomModal(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-75 z-50 p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                    <p class="text-white mb-4">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" class="px-6 py-2 btn-primary rounded-lg">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showMessage(text, sender = null, isSystem = false, isAI = false) {
            const div = document.createElement('div');
            if (isSystem) {
                div.textContent = text;
                div.classList.add('system-msg');
            } else if (isAI) {
                const markdown = marked.parse(text);
                div.innerHTML = `<strong>✨ Gemini:</strong><div class="ai-msg">${markdown}</div>`;
            } else {
                const senderName = (sender === username) ? 'Você' : sender;
                div.innerHTML = `<strong class="text-indigo-300">${senderName}:</strong> ${text}`;
            }
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Função para ler o texto em voz alta
        function speakText(text) {
            // A fala só ocorrerá se o TTS for ativado localmente por um comando.
            if ((ttsEnabled || isTtsAllEnabled) && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                window.speechSynthesis.speak(utterance);
            }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                authStatus.textContent = 'Conectado com sucesso!';
                btnCreateRoom.disabled = false;
                btnJoinRoom.disabled = false;
            } else {
                auth.signInAnonymously().catch(err => {
                    authStatus.textContent = 'Falha na autenticação: ' + err.message;
                });
            }
        });
        
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function checkWebRTCSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                const message = "Seu navegador não suporta WebRTC, então o compartilhamento de tela e o chat de voz não funcionarão.";
                showCustomModal(message);
                return false;
            }
            return true;
        }
        
        function cleanupListeners() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
        }

        // === ROOM MANAGEMENT ===
        async function createRoom() {
            username = usernameInput.value.trim();
            if (!userId || !username) {
                showCustomModal('Por favor, insira um nome de usuário.');
                return;
            }
            if (!checkWebRTCSupport()) return;

            btnCreateRoom.disabled = true;
            btnCreateRoom.textContent = 'Criando...';
            
            isRoomCreator = true;
            currentRoomId = generateRoomCode();
            
            const roomRef = db.collection('movie-rooms').doc(currentRoomId);
            try {
                await roomRef.set({ 
                    creatorId: userId, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isBroadcasting: false
                });
                await joinRoom(currentRoomId);
            } catch (e) {
                console.error("Error creating room:", e);
                showCustomModal('Falha ao criar a sala. Tente novamente.');
                isRoomCreator = false;
                currentRoomId = null;
            } finally {
                btnCreateRoom.disabled = false;
                btnCreateRoom.textContent = 'Criar Nova Sala';
            }
        }

        async function joinRoom(code) {
            if (!code) { // Called from button click
                username = usernameInput.value.trim();
                code = roomInput.value.trim().toUpperCase();
                if (!userId || !username) return showCustomModal('Por favor, insira um nome de usuário.');
                if (!code) return showCustomModal('Por favor, insira um código de sala válido.');
                if (!checkWebRTCSupport()) return;
                btnJoinRoom.disabled = true;
                btnJoinRoom.textContent = 'Entrando...';
            }

            const roomRef = db.collection('movie-rooms').doc(code);
            const roomSnapshot = await roomRef.get();

            if (!roomSnapshot.exists) {
                showCustomModal(`A sala "${code}" não foi encontrada.`);
                btnJoinRoom.disabled = false;
                btnJoinRoom.textContent = 'Entrar';
                return;
            }

            currentRoomId = code;
            const roomData = roomSnapshot.data();
            if (roomData.creatorId === userId) {
                isRoomCreator = true;
            }

            await roomRef.collection('participants').doc(userId).set({
                username: username,
                joinedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            menu.style.display = 'none';
            app.style.display = 'flex';
            roomCodeDisplay.textContent = currentRoomId;
            hostControls.style.display = isRoomCreator ? 'block' : 'none';
            
            setupRoomListeners();
            
            if (!isRoomCreator) {
                videoPlaceholderText.textContent = roomData.isBroadcasting ? 'Conectando ao stream...' : 'Esperando o host compartilhar a tela...';
            } else {
                videoPlaceholderText.textContent = 'Clique em "Compartilhar Tela" para iniciar.';
            }

            btnJoinRoom.disabled = false;
            btnJoinRoom.textContent = 'Entrar';
        }

        async function leaveRoom(userInitiated = true) {
            if (!currentRoomId) return;

            // Clean up all peer connections
            peers.forEach(p => p.destroy());
            peers.clear();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (userInitiated) {
                 await db.collection('movie-rooms').doc(currentRoomId).collection('participants').doc(userId).delete();
                 if (isRoomCreator) {
                     await db.collection('movie-rooms').doc(currentRoomId).update({ isBroadcasting: false });
                     // Deleting the room is too aggressive, just update the broadcasting status
                 }
            }
            
            cleanupListeners();
            
            currentRoomId = null;
            isRoomCreator = false;
            remoteVideo.srcObject = null;
            remoteVideo.classList.add('hidden');
            videoPlaceholder.style.display = 'flex';
            pipButton.style.display = 'none';
            
            menu.style.display = 'flex';
            app.style.display = 'none';
            chatMessages.innerHTML = '';
        }

        // === LISTENERS ===
        function setupRoomListeners() {
            const roomRef = db.collection('movie-rooms').doc(currentRoomId);
            
            // General room listener (for broadcast status)
            const unsubRoom = roomRef.onSnapshot(doc => {
                if (!doc.exists) {
                    showCustomModal("A sala foi fechada pelo anfitrião.");
                    leaveRoom(false);
                    return;
                }
                const roomData = doc.data();
                if (!isRoomCreator) {
                    // Participant: check if host started broadcasting
                    if (roomData.isBroadcasting && !peers.has(roomData.creatorId)) {
                        initiateVideoPeer(roomData.creatorId);
                    }
                }
            });
            unsubscribers.push(unsubRoom);
            
            // Participants listener
            const unsubParticipants = roomRef.collection('participants').onSnapshot(snapshot => {
                participantsList.innerHTML = '';
                const participantIds = new Set();
                snapshot.forEach(doc => {
                    const participant = doc.data();
                    participantIds.add(doc.id);
                    const li = document.createElement('li');
                    li.textContent = `${participant.username} ${doc.id === userId ? '(Você)' : ''}`;
                    participantsList.appendChild(li);
                });
                
                // For host: manage peer connections for new participants
                if (isRoomCreator && localStream) {
                    participantIds.forEach(id => {
                        if (id !== userId && !peers.has(id)) {
                             createPeer(id, true, localStream);
                        }
                    });
                }
                
                // Remove peers for participants who left
                peers.forEach((peer, id) => {
                    if (!participantIds.has(id)) {
                        peer.destroy();
                        peers.delete(id);
                    }
                });
            });
            unsubscribers.push(unsubParticipants);

            // Signal listener: listen for signals from anyone else in the room
            const unsubSignals = roomRef.collection('signals')
                .where('recipientId', '==', userId)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const signalData = change.doc.data();
                            const senderId = signalData.senderId;
                            let peer = peers.get(senderId);
                            
                            if (!peer) {
                                // If peer doesn't exist, create it. This is for participants receiving the initial offer.
                                peer = createPeer(senderId, false, null);
                            }

                            // Signal the peer with the received data
                            peer.signal(signalData.data);
                            
                            // Delete the signal document after processing
                            change.doc.ref.delete().catch(err => console.error("Error deleting signal doc:", err));
                        }
                    });
                });
            unsubscribers.push(unsubSignals);
            
            // Chat listener
            const unsubChat = roomRef.collection('chat').orderBy('timestamp').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const msg = change.doc.data();
                        
                        // Não mostre a mensagem que o próprio usuário enviou (evita duplicatas).
                        if (msg.senderId === userId) {
                            return; 
                        }

                        // Verifica a mensagem do sistema para atualizar o estado do TTS para todos
                        if (msg.isSystem && msg.text.includes('ativado para todos')) {
                            isTtsAllEnabled = true;
                        } else if (msg.isSystem && msg.text.includes('desativado para todos')) {
                            isTtsAllEnabled = false;
                        }

                        // Lê a mensagem em voz alta, mas apenas se o narrador estiver ativado localmente ou para todos
                        if (!msg.isSystem && (ttsEnabled || isTtsAllEnabled)) {
                            speakText(msg.text);
                        }
                        
                        showMessage(msg.text, msg.username, msg.isSystem, msg.isAI);
                    }
                });
            });
            unsubscribers.push(unsubChat);
        }
        
        // === WEBRTC PEER MANAGEMENT (REFACTORED) ===
        // This function creates and configures a SimplePeer instance
        function createPeer(partnerId, initiator, stream) {
            const peer = new SimplePeer({ initiator, trickle: false, stream });
            
            peer.on('signal', data => {
                // Send the signal to Firestore for the other peer to pick up
                db.collection('movie-rooms').doc(currentRoomId)
                  .collection('signals').add({
                      senderId: userId,
                      recipientId: partnerId,
                      data: data,
                      timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            });
            
            // Only participants need to listen for streams
            if (!initiator) {
                peer.on('stream', remoteStream => {
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.classList.remove('hidden');
                    videoPlaceholder.style.display = 'none';
                    pipButton.style.display = 'block';
                });
            }
            
            peer.on('connect', () => {
                console.log(`Connected with peer ${partnerId}`);
                videoPlaceholderText.textContent = 'Conectado!';
            });

            peer.on('close', () => {
                console.log(`Connection closed with peer ${partnerId}`);
                peers.delete(partnerId);
                // If the host leaves, clean up the player
                if (partnerId === (isRoomCreator ? 'N/A' : currentRoomId)) { // Simple check for host
                     remoteVideo.srcObject = null;
                     remoteVideo.classList.add('hidden');
                     videoPlaceholder.style.display = 'flex';
                     videoPlaceholderText.textContent = 'Esperando o host compartilhar a tela...';
                }
            });

            peer.on('error', err => console.error(`Peer error with ${partnerId}:`, err));
            
            peers.set(partnerId, peer);
            return peer;
        }
        
        // Function to start the screen sharing broadcast (Host)
        async function startVideoBroadcast() {
            if (!isRoomCreator) return;
            try {
                videoPlaceholderText.textContent = 'Solicitando permissão para compartilhar...';
                localStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        frameRate: { ideal: 30, max: 60 },
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 }
                    },
                    audio: true
                });
                
                // Show the local stream as a preview on the host's screen
                remoteVideo.srcObject = localStream;
                remoteVideo.muted = true;
                remoteVideo.classList.remove('hidden');
                videoPlaceholder.style.display = 'none';
                pipButton.style.display = 'block';
                btnStartShare.textContent = 'Parar Compartilhamento';
                
                await db.collection('movie-rooms').doc(currentRoomId).update({ isBroadcasting: true });
                
                // Create a peer connection for each participant in the room
                const participantsSnapshot = await db.collection('movie-rooms').doc(currentRoomId).collection('participants').get();
                participantsSnapshot.forEach(doc => {
                    if (doc.id !== userId) {
                        createPeer(doc.id, true, localStream);
                    }
                });

                // Listen for when the screen share ends
                localStream.getVideoTracks()[0].onended = () => {
                    stopVideoBroadcast();
                };

            } catch (err) {
                console.error("Error starting screen share:", err);
                showCustomModal("Não foi possível iniciar o compartilhamento de tela. Verifique as permissões do seu navegador.");
            }
        }

        // Function to stop the screen sharing broadcast (Host)
        async function stopVideoBroadcast() {
            if (!isRoomCreator) return;
            await db.collection('movie-rooms').doc(currentRoomId).update({ isBroadcasting: false });
            peers.forEach(peer => peer.destroy());
            peers.clear();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            remoteVideo.srcObject = null;
            remoteVideo.classList.add('hidden');
            videoPlaceholder.style.display = 'flex';
            pipButton.style.display = 'none';
            btnStartShare.textContent = 'Compartilhar Tela';
            videoPlaceholderText.textContent = 'Clique em "Compartilhar Tela" para iniciar.';
        }
        
        // Function to initiate peer connection for a participant (Participant)
        function initiateVideoPeer(creatorId) {
            videoPlaceholderText.textContent = 'Iniciando conexão com o host...';
            // Create the peer and signaling logic will be handled by the listener
            createPeer(creatorId, false, null);
        }

        // === TEXT CHAT ===
        function sendChatMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            // Se for o comando do admin para todos
            if (text.toLowerCase() === '/tts all') {
                if (isRoomCreator) {
                    isTtsAllEnabled = !isTtsAllEnabled;
                    const statusMessage = {
                        senderId: userId,
                        username: username,
                        text: `O narrador foi ${isTtsAllEnabled ? 'ativado' : 'desativado'} para todos por ${username}.`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        isSystem: true // Mensagem do sistema
                    };
                    db.collection('movie-rooms').doc(currentRoomId).collection('chat').add(statusMessage);
                } else {
                    showCustomModal("Apenas o criador da sala pode usar este comando.");
                }
            } 
            // Se for o comando individual
            else if (text.toLowerCase() === '/tts') {
                ttsEnabled = !ttsEnabled;
                const statusMessage = {
                    senderId: userId,
                    username: username,
                    text: `O narrador de ${username} foi ${ttsEnabled ? 'ativado' : 'desativado'}.`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isSystem: true // Mensagem do sistema
                };
                db.collection('movie-rooms').doc(currentRoomId).collection('chat').add(statusMessage);
            }
            // Se for uma mensagem normal
            else {
                // Lê a mensagem em voz alta, mas apenas se o narrador estiver ativado localmente ou para todos
                if (ttsEnabled || isTtsAllEnabled) {
                    speakText(text);
                }
                const message = {
                    senderId: userId,
                    username: username,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isSystem: false
                };
                db.collection('movie-rooms').doc(currentRoomId).collection('chat').add(message);
            }
            chatInput.value = '';
        }

        // === EVENT HANDLERS ===
        btnCreateRoom.onclick = createRoom;
        btnJoinRoom.onclick = () => joinRoom(null);
        btnLeaveRoom.onclick = () => leaveRoom(true);
        sendChatBtn.onclick = sendChatMessage;
        chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendChatMessage(); });
        
        btnStartShare.onclick = () => {
            if (localStream) {
                stopVideoBroadcast();
            } else {
                startVideoBroadcast();
            }
        };

        pipButton.onclick = () => {
            if (document.pictureInPictureElement) {
                document.exitPictureInPicture();
            } else if (remoteVideo.srcObject) {
                remoteVideo.requestPictureInPicture();
            }
        };

        btnShowParticipants.onclick = () => participantsModal.style.display = 'block';
        closeModal.forEach(btn => {
            btn.onclick = () => {
                participantsModal.style.display = 'none';
                invitationModal.style.display = 'none';
            };
        });
        window.onclick = event => {
            if (event.target == participantsModal || event.target == invitationModal) {
                event.target.style.display = 'none';
            }
        };

        // === AI FUNCTIONS ===
        btnGenerateInvitation.onclick = function() {
            const roomUrl = window.location.href.split('?')[0] + '?room=' + currentRoomId;
            const prompt = `Gere um convite criativo e amigável para uma sessão de cinema virtual. Mencione que a sala se chama "${currentRoomId}" e que o link para entrar é ${roomUrl}. O convite deve ser divertido e convidar amigos para se juntarem para assistir a um filme juntos.`;
            callGeminiAPI(prompt, invitationText);
            invitationModal.style.display = 'block';
        };

        btnGenerateIcebreakers.onclick = function() {
            const prompt = "Gere 5 perguntas divertidas para quebra-gelo para usar em uma sessão de cinema virtual com amigos. As perguntas devem ser simples e focadas em gostos de filmes, como 'Qual filme você assistiria para sempre?', 'Qual ator ou atriz você escolheria para ser seu melhor amigo(a)?' etc. Apresente as perguntas em formato de lista numerada.";
            callGeminiAPI(prompt, chatMessages);
        };
        
        copyInvitationBtn.onclick = function() {
            document.execCommand('copy');
            showCustomModal('Convite copiado!');
        };

        async function callGeminiAPI(prompt, outputElement) {
            const isChatOutput = outputElement === chatMessages;
            let loadingDiv;
            if (isChatOutput) {
                loadingDiv = document.createElement('div');
                loadingDiv.innerHTML = `<div class="ai-msg"><strong>✨ Gemini:</strong> Gerando... <span class="inline-flex items-center"><span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span></span></div>`;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                outputElement.textContent = 'Gerando...';
            }

            const apiKey = ""; // API key will be provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                const result = await response.json();
                
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    if (isChatOutput) {
                        showMessage(text, null, false, true);
                    } else {
                        outputElement.textContent = text;
                    }
                } else {
                    throw new Error("Resposta da API inválida.");
                }

            } catch (err) {
                console.error("Error in Gemini API:", err);
                const errorMsg = 'Erro ao gerar conteúdo. Tente novamente mais tarde.';
                if (isChatOutput) {
                    showMessage(errorMsg, null, true);
                } else {
                    outputElement.textContent = errorMsg;
                }
            } finally {
                if (loadingDiv) loadingDiv.remove();
            }
        }
    </script>
</body>
</html>
