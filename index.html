<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Movie Room with Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        #chatMessages {
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
            background: #1f2937;
            border-radius: 0.5rem;
        }

        #chatMessages div {
            margin-bottom: 0.5rem;
        }

        .system-msg {
            text-align: center;
            font-style: italic;
            color: #9ca3af;
        }

        /* Classes de estilo para os botões */
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }
    </style>
</head>
<body>

    <div id="container" class="max-w-xl w-full p-6 bg-gray-900 rounded-xl shadow-lg flex flex-col">

        <!-- UI do Menu -->
        <div id="menu" class="flex flex-col items-center">
            <h1 class="text-3xl font-bold mb-2">Movie Room</h1>
            <p class="mb-6 text-gray-400">Crie uma sala para assistir com amigos</p>

            <button id="btnCreateRoom" class="w-full py-3 mb-4 btn-primary">Create New Room</button>

            <div class="flex gap-2 mb-4 w-full">
                <input id="roomInput" placeholder="CÓDIGO DA SALA" maxlength="4" class="flex-grow p-3 rounded bg-gray-700 text-white uppercase focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                <button id="btnJoinRoom" class="py-3 px-5 bg-gray-600 rounded text-white font-bold">Entrar</button>
            </div>

            <p id="authStatus" class="text-gray-400 text-sm">Autenticando...</p>
        </div>

        <!-- UI da Aplicação -->
        <div id="app" class="hidden flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Sala: <span id="roomCodeDisplay" class="text-indigo-400"></span></h2>
                <button id="btnLeaveRoom" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition">Sair da Sala</button>
            </div>

            <!-- Vídeo principal que exibe o stream local (host) ou remoto (cliente) -->
            <video id="remoteVideo" autoplay playsinline controls class="w-full h-64 bg-black rounded mb-4"></video>

            <!-- Placeholder enquanto espera o stream -->
            <div id="videoPlaceholder" class="text-center text-gray-400 mb-4">
                <p>Esperando o host compartilhar a tela...</p>
                <button id="btnStartShare" class="mt-3 btn-primary">Compartilhar Tela</button>
            </div>

            <!-- Área de chat -->
            <div id="chatMessages" class="mb-3"></div>

            <div class="flex gap-2">
                <input id="chatInput" placeholder="Digite sua mensagem..." class="flex-grow p-2 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                <button id="sendChatBtn" class="btn-primary">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // === CONFIGURAÇÃO FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyA3HIqR4rT3NANEulauFy_-3OkuWOqYhqk",
            authDomain: "salinha-de-filme.firebaseapp.com",
            projectId: "salinha-de-filme",
            storageBucket: "salinha-de-filme.firebasestorage.app",
            messagingSenderId: "589071044223",
            appId: "1:589071044223:web:2e8c6e0b4644bc99fbf94a"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const btnCreateRoom = document.getElementById('btnCreateRoom');
        const btnJoinRoom = document.getElementById('btnJoinRoom');
        const roomInput = document.getElementById('roomInput');
        const authStatus = document.getElementById('authStatus');
        const menu = document.getElementById('menu');
        const app = document.getElementById('app');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const btnLeaveRoom = document.getElementById('btnLeaveRoom');
        const remoteVideo = document.getElementById('remoteVideo');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const btnStartShare = document.getElementById('btnStartShare');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');

        // Variáveis de estado
        let userId = null;
        let currentRoomId = null;
        let peer = null;
        let localStream = null;
        let isRoomCreator = false;

        // Listeners de Firestore para desinscrição
        let unsubscribeRoom = null;
        let unsubscribeChat = null;
        let unsubscribeCandidates = null;
        
        // Função para exibir um modal customizado em vez de um `alert()`
        function showModal(message) {
            const modal = document.createElement('div');
            modal.classList.add('fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-75', 'z-50');
            modal.innerHTML = `
              <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-white max-w-sm w-full text-center">
                <p class="mb-4">${message}</p>
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 btn-primary hover:bg-indigo-700 transition">OK</button>
              </div>
            `;
            document.body.appendChild(modal);
        }

        /**
         * Exibe uma mensagem no painel de chat.
         * @param {string} text - O texto da mensagem.
         * @param {string|null} sender - O remetente da mensagem (ex: 'Você', 'Amigo'). Nulo para mensagens do sistema.
         * @param {boolean} isSystem - Verdadeiro se for uma mensagem do sistema.
         */
        function showMessage(text, sender = null, isSystem = false) {
            const div = document.createElement('div');
            if (isSystem) {
                div.textContent = text;
                div.classList.add('system-msg');
            } else {
                div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            }
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                userId = user.uid;
                authStatus.textContent = 'Conectado com sucesso!';
                btnCreateRoom.disabled = false;
                btnJoinRoom.disabled = false;
            } else {
                userId = null;
                authStatus.textContent = 'Autenticando...';
                btnCreateRoom.disabled = true;
                btnJoinRoom.disabled = true;
                if (!auth.currentUser) {
                    auth.signInAnonymously().catch(err => {
                        authStatus.textContent = 'Não foi possível conectar aos serviços: ' + err.message;
                        console.error("Erro na autenticação anônima:", err);
                    });
                }
            }
        });

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // --- FUNÇÕES DE CONEXÃO E LIMPEZA ---
        
        /**
         * Encerra a conexão e limpa o estado.
         */
        async function hangUp(userInitiated = false) {
            if (peer) {
                peer.destroy();
                peer = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (unsubscribeRoom) {
                unsubscribeRoom();
                unsubscribeRoom = null;
            }
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            if (unsubscribeCandidates) {
                unsubscribeCandidates();
                unsubscribeCandidates = null;
            }

            if (isRoomCreator && currentRoomId && userInitiated) {
                try {
                    const roomRef = db.collection('movie-rooms').doc(currentRoomId);
                    await roomRef.delete();
                } catch (error) {
                    console.error("Erro ao apagar a sala:", error);
                }
            }

            currentRoomId = null;
            remoteVideo.srcObject = null;
            chatMessages.innerHTML = '';
            chatInput.value = '';
            roomInput.value = '';
            isRoomCreator = false;

            menu.style.display = 'flex';
            app.style.display = 'none';

            btnCreateRoom.disabled = false;
            btnCreateRoom.textContent = 'Create New Room';
            btnJoinRoom.disabled = false;
            btnJoinRoom.textContent = 'Entrar';
            btnStartShare.disabled = false;
            btnStartShare.textContent = 'Compartilhar Tela';
            videoPlaceholder.style.display = 'block';
        }

        // --- HANDLERS DE EVENTOS ---
        
        btnCreateRoom.onclick = async () => {
            if (!userId) {
                showModal('Autenticando... Por favor, aguarde.');
                return;
            }

            btnCreateRoom.disabled = true;
            btnCreateRoom.textContent = 'Criando...';
            currentRoomId = generateRoomCode();
            roomCodeDisplay.textContent = currentRoomId;
            isRoomCreator = true;

            const roomRef = db.collection('movie-rooms').doc(currentRoomId);
            await roomRef.set({ creatorId: userId, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

            menu.style.display = 'none';
            app.style.display = 'flex';
            setupChatListener();
            
            btnCreateRoom.textContent = 'Create New Room';
            btnCreateRoom.disabled = false;
        };

        btnJoinRoom.onclick = async () => {
            if (!userId) {
                showModal('Autenticando... Por favor, aguarde.');
                return;
            }

            const code = roomInput.value.trim().toUpperCase();
            if (!code || code.length !== 4) {
                showModal('Por favor, insira um código válido de 4 letras.');
                return;
            }

            btnJoinRoom.disabled = true;
            btnJoinRoom.textContent = 'Entrando...';
            currentRoomId = code;
            roomCodeDisplay.textContent = currentRoomId;
            isRoomCreator = false;

            const roomRef = db.collection('movie-rooms').doc(currentRoomId);
            const roomSnapshot = await roomRef.get();

            if (!roomSnapshot.exists) {
                showModal(`A sala "${currentRoomId}" não foi encontrada.`);
                btnJoinRoom.disabled = false;
                btnJoinRoom.textContent = 'Entrar';
                return;
            }
            
            // --- INÍCIO DA CORREÇÃO DE TRANSMISSÃO ---
            // 1. Cria o peer imediatamente
            peer = new SimplePeer({ initiator: false, trickle: true });

            // 2. Configura todos os ouvintes do peer para que ele esteja pronto
            peer.on('signal', async data => {
                const roomRef = db.collection('movie-rooms').doc(currentRoomId);
                if (data.type === 'answer') {
                    await roomRef.update({ answer: data });
                } else if (data.candidate) {
                    const calleeCandidates = roomRef.collection('calleeCandidates');
                    await calleeCandidates.add(data);
                }
            });

            peer.on('stream', stream => {
                videoPlaceholder.style.display = 'none';
                remoteVideo.srcObject = stream;
                remoteVideo.muted = false; // Áudio ativado para o cliente
                remoteVideo.play().catch(e => console.error("Erro ao reproduzir o vídeo remoto:", e));
            });

            peer.on('connect', () => {
                showMessage('Amigo conectado!', null, true);
            });
            
            peer.on('close', () => {
                showMessage('Amigo desconectado.', null, true);
                hangUp();
            });

            peer.on('error', err => {
                showModal('Erro na conexão: ' + err.message);
                hangUp();
            });

            // 3. Agora, ouve as coleções do Firestore para processar os sinais do host
            const callerCandidates = roomRef.collection('callerCandidates');
            unsubscribeCandidates = callerCandidates.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        if (peer) {
                            peer.signal(change.doc.data());
                        }
                    }
                });
            });

            unsubscribeRoom = roomRef.onSnapshot(async snapshot => {
                const roomData = snapshot.data();
                if (roomData && roomData.offer && peer && !peer.connected) { 
                    peer.signal(roomData.offer);
                }
            });
            // --- FIM DA CORREÇÃO DE TRANSMISSÃO ---

            menu.style.display = 'none';
            app.style.display = 'flex';
            setupChatListener();
            btnJoinRoom.disabled = false;
            btnJoinRoom.textContent = 'Entrar';
        };

        btnStartShare.onclick = async () => {
            if (!currentRoomId) {
                showModal('Por favor, crie uma sala antes de compartilhar a tela.');
                return;
            }
            if (isRoomCreator && peer) {
                showModal('Você já está compartilhando a tela.');
                return;
            }

            try {
                localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });

                remoteVideo.srcObject = localStream;
                remoteVideo.muted = false; 
                videoPlaceholder.style.display = 'none';

                peer = new SimplePeer({ initiator: true, trickle: true, stream: localStream });

                const roomRef = db.collection('movie-rooms').doc(currentRoomId);
                const callerCandidates = roomRef.collection('callerCandidates');

                peer.on('signal', async data => {
                    if (data.type === 'offer') {
                        await roomRef.set({
                            offer: data,
                            creatorId: userId,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    } else if (data.candidate) {
                        await callerCandidates.add(data);
                    }
                });

                unsubscribeRoom = roomRef.onSnapshot(snapshot => {
                    const data = snapshot.data();
                    if (data && data.answer) {
                        if (peer && data.answer.type === 'answer') {
                            peer.signal(data.answer);
                        }
                    }
                });
                
                const calleeCandidates = roomRef.collection('calleeCandidates');
                unsubscribeCandidates = calleeCandidates.onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            if (peer) {
                                peer.signal(change.doc.data());
                            }
                        }
                    });
                });

                peer.on('connect', () => {
                    showMessage('Amigo conectado!', null, true);
                });
                
                peer.on('stream', stream => {
                    // O host já exibe o próprio stream, então este é ignorado.
                    console.log('Stream remoto recebido pelo host, ignorando.');
                });
                
                peer.on('close', () => {
                    showMessage('Amigo desconectado.', null, true);
                    hangUp();
                });

                peer.on('error', err => {
                    showModal('Erro na conexão: ' + err.message);
                    hangUp();
                });
                
                localStream.getVideoTracks()[0].onended = () => {
                    showMessage('Compartilhamento de tela encerrado.', null, true);
                    hangUp();
                };

                btnStartShare.disabled = true;
                btnStartShare.textContent = 'Compartilhando...';
            } catch (err) {
                console.error("Erro ao compartilhar tela:", err);
                showModal('Permissão para compartilhar a tela negada ou ocorreu um erro.');
            }
        };

        sendChatBtn.onclick = async () => {
            const text = chatInput.value.trim();
            if (!text || !currentRoomId) return;
            
            showMessage(text, 'Você');
            chatInput.value = '';

            try {
                const chatRef = db.collection('movie-rooms').doc(currentRoomId).collection('chat');
                await chatRef.add({
                    text,
                    senderId: userId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                showMessage('Falha ao enviar a mensagem.', null, true);
                console.error("Erro ao enviar mensagem de chat:", e);
            }
        };

        chatInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatBtn.click();
            }
        });

        function setupChatListener() {
            if (unsubscribeChat) unsubscribeChat();
            const chatRef = db.collection('movie-rooms').doc(currentRoomId).collection('chat').orderBy('timestamp');
            unsubscribeChat = chatRef.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        if (data.senderId !== userId) {
                            showMessage(data.text, 'Amigo');
                        }
                    }
                });
            });
        }

        btnLeaveRoom.onclick = () => {
            hangUp(true);
        };

        window.addEventListener('beforeunload', () => {
            if (isRoomCreator && currentRoomId) {
                db.collection('movie-rooms').doc(currentRoomId).delete()
                    .then(() => console.log("Sala apagada ao descarregar a página (criador)."))
                    .catch(e => console.error("Erro ao apagar sala ao descarregar:", e));
            }
        });

        window.onload = () => {
            btnCreateRoom.disabled = true;
            btnJoinRoom.disabled = true;
        };
    </script>
</body>
</html>
